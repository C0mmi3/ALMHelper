# ALM Helper #
Данный модуль предназначен для автоматизации работы с дефектами в системе ALM.
Модуль использует HP ALM REST API для обмена данными с системой баг-трекинга,
А также библиотеку GSON для работы с JSON-объектами.

----------------------------------------------------------------------------
#### Краткое описание функционала ####
1) Авторизация в ALM (POST HTTP/ALM REST API)
2) Получение дефекта из ALM (GET HTTP/ALM REST API)
3) Обновление дефекта в ALM (PUT HTTP/ALM REST API)
4) Получение списка дефектов

----------------------------------------------------------------------------
#### Функционал ####
1) Авторизация в системе ALM. Метод POSTAuthenticate класса HTTPRequest.
Для авторизации используются следующие параметры из файла config.properties:
alm.server.api.user = Имя пользователя в системе ALM
alm.server.api.password = Пароль пользователя в системе ALM
В результате выполнения данного метода заполняется параметр cookies с данными о пользователе и его сессии

2) Получение дефекта из ALM. Метод GETDefect класса HTTPRequest.
Входной параметр метода - ID дефекта.
На выходе мы получаем JSON-объект, в котором содержатся все данные по дефекту.

3) Подготовка дефекта к обновлению. Метод prepareDefect.
Входной параметр метода - JSON-объект, полученный методом GETDefect.
На выходе мы получаем уменьшенный JSON-объект, в котором содержатся следующие поля:
* OWNER - пользователь ALM, на которого будет переведен дефект. В параметре alm.exclude.users в config.properties передается список пользователей через разделитель ",", на которых нельзя переводить дефекты.
В таком случае дефекты будут переведены на пользователя, указанного в параметре alm.default.user
* STATUS - обновленный статус дефекта. Сейчас все дефекты автоматически переводятся в статус "Fixed"
* DEV-COMMENTS - комментарий, отображающийся в ALM. Формируется следующим образом:
Берется значение поля DEV-COMMENTS из полученного методом GETDefect объекта. К нему прибавляется текущая дата и параметры из config.properties:
alm.defect.comment = Комментарий в кодировке UNICODE, который добавляется к дефекту. Поддерживает спецпараметр %DATE%, проставляющий текущую дату в формате dd.mm.yyyy
alm.server.api.credentials = ФИО пользователя ALM, от которого осуществляется вход в систему.

4) Обновление дефекта. Метод PUTUpdateDefect.
Входной параметр метода  - JSON-объект, полученный методом prepareDefect.
Основная логика находится в методе main класса Processor.

5) Получение списка дефектов. Метод getList.
Расположение файла со списком дефектов задается в config.properties:
alm.defects.list.file.path

6) Архивирование списка дефектов. Метод archiveList.
Расположение директории с историей поставок задается в config.properties:
alm.helper.history.directory

7) Завершение пользовательской сессии. Метод signOut.
Добавлен в 1.1.1 от 12.04.2016

8) Режим наблюдателя. Модуль мониторит указанную директорию на предмет появления/изменения файла со списком дефектов. Если файл появился/изменился, начинает обработку.
Добавлен в 1.2 от 14.04.2016
----------------------------------------------------------------------------
#### ЗАПУСК ####
В командной строке выполнить следующую команду: java -jar /path-to-jar/ALMHelper.jar MODE
Где MODE: RUN_ONCE,WATCH
RUN_ONCE - единовременный запуск. Обработали список, выключились. Если не задать параметров запуска, то будет работать в этом режиме
WATCH - запуск в режиме наблюдателя. Модуль будет следить за появлением/изменением файла list.txt. Если он появился/изменился, то немедленно обработает его

#### ЛОГИРОВАНИЕ ####
Настройки логирования задаются в конфиге log4j2.xml. Сейчас имеется 3 логгера: ALMHelper, Processor, Observer.
ALMHelper и Processor пишут логи в файл helper.log и консоль
Observer пишет логи только в файл watchdog.log
----------------------------------------------------------------------------
#### История версий ####
1.0:
* Авторизация
* Получение дефекта
* Подготовка к апдейту дефекта
* Апдейт дефекта

1.1.1:
* Прерывание пользовательской сессии (sign-out)
* Обработка статуса Closed

1.2:
* Режим наблюдателя
* Логирование посредством log4j2

1.3:
* Унификация логики работы в режиме наблюдателя и в режиме единоразового запуска
* Обработка статуса Fixed
* Новый логгер для сохранения ошибок по дефектам
* Очистка cookies
* Новый служебный класс CommentsHelper для формирования комментариев к дефекту

2.0 (package com.test):
* Работа с ПРОМ ALM
Поддержка возможна благодаря общему базовому классу HelperBase. Многие методы общие как для ПРОМ ALM, так и для тестового.
Работа пока только началась.
* Резервное копирование исходной информации о дефекте. Откат изменений
* Переработанная и улучшенная архитектура модуля
Закончена работа по переносу функционала класса ALMHelper. TestHelper полностью работоспособен.
Базовая логика (аутентификация, выход, получение дефекта, апдейт дефекта, создание дефекта) вынесены в абстрактный класс HelperBase.
Там же определен абстрактный метод process(), который отвечает за общую логику работы. В TestHelper он полностью идентичен ALMHelper по функциональности.
* Рубильник для включения/выключения архивации списка дефектов
* Обработчик проблемных дефектов (Обработка ошибки 403)
Версия 2.0 пока сохраняет старую реализацию.